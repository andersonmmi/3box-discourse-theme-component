<!--  -->
<script type="text/javascript">console.log("Code is running!");</script>
<script type="text/discourse-plugin" version="0.8">
    console.log("This Code is also Running!!!");
</script>

<script type='text/x-handlebars' data-template-name='/connectors/user-preferences-account/discourse-maker-badges-theme-component'>
    <script>
        const clickButton = () => {
            // get username here without defining getUsername()?
        
            const regex = /\/u\/([a-zA-Z0-9_-]*)\//gm;
            const str = window.location.href;
            let m;
            let username;

            console.log("getUsername fired!", str)
        
            while ((m = regex.exec(str)) !== null) {
                // This is necessary to avoid infinite loops with zero-width matches
                if (m.index === regex.lastIndex) {
                    regex.lastIndex++;
                }

                console.log("m[1]", m[1])
                username = m[1]
            }
        // call getUsername here
        // getUsername();
        console.log("username", username)

        // :alembic: message params should be username & ethAddress
        window.ethereum.sendAsync(  {
            method: 'personal_sign',
            params: [
                `${username}`, window.ethereum.selectedAddress
                    ],
            from: window.ethereum.selectedAddress
        
        },
        (error, response) => {
            if (error) {
            // Handle error. Likely the user rejected the login
            console.error("error with signing message:", error);
            } else {
            // Q: What does the message look like?
            const message = `{"username":"${username}","address":"${window.ethereum.selectedAddress}","signature":"${response.result}"}`
            console.log("ajax message:", message)
            // @Aaron: pass message to lambda function
            const requestOptions = {
                method: 'GET'
            };
            fetch(
                `http://localhost:3000/discourse/${message}`,
                requestOptions
            )
            .then(res => res.json())
            .then(resolved => console.log("Fetch Response Too Yo!", resolved))

            // A: pending...
            // :alembic: username is undefined, but address is recoverable

            }
        })
        }
        
        const connectWallet = () => {
        window.ethereum.enable();
        }
    </script>
    
    <div class='control-label'>
        Claim MakerDAO Badges
      </div>
      <div class='display-flex'>
        First
        <div class='buttons'>
          {{d-button label="wallet_connect.add_button" action="connectWallet" }}
        </div>
        , then
        <div class='buttons'>
          {{d-button label="wallet_link.add_button" action="clickButton"}}
        </div>
        .
      </div>
      <div class='text-field'>
        {{
          text-field 
          label="wallet_address.text_field" 
          placeholder="Wallet address go here!" 
          value="No version of plugin.test_address works"
        }}
      </div>
</script>