<script type="text/discourse-plugin" version="0.8">
    console.log("Maker Badge Theme Component Running");
</script>

<script type="text/x-handlebars" data-template-name="/connectors/user-preferences-account/maker-badges">
    <div class='control-label'>
        Claim MakerDAO Badges
    </div>
    {{mount-widget widget="maker-badges-loader-widget"}}
</script>

<script type="text/discourse-plugin" version="0.8">
console.log("Discourse:", Discourse);

// const h require("virtual-dom").h;

api.createWidget('maker-badges-loader-widget', {
    tagName: "button.maker-badges",
    html() {
        return "Import Maker Badges";
    },
    click(e) {
        e.preventDefault();
        console.log("Maker badge loader button got clicked");

        const username = Discourse.currentUser.username;
        console.log("Username", username);

        // window.ethereum.enable();  // Deprecated

        try {
            // Request wallet access and accout list
            window.ethereum.request('eth_requestAccounts').then((accounts) => {
                console.log("Ethereum Accounts", accounts);
                        // :alembic: message params should be username & ethAddress
                window.ethereum.sendAsync(  {
                        method: 'personal_sign',
                        params: [
                            `${username}`, window.ethereum.selectedAddress
                        ],
                        from: window.ethereum.selectedAddress

                    },
                    (error, response) => {
                        if (error) {
                            // Handle error. Likely the user rejected the login
                            console.error("error with signing message:", error);
                        } else {
                            // Q: What does the message look like?
                            const message = `{"username":"${username}","address":"${window.ethereum.selectedAddress}","signature":"${response.result}"}`
                            console.log("ajax message:", message);
                            // @Aaron: pass message to lambda function
                            const requestOptions = {
                                method: 'GET'
                            };
                            fetch(
                                `http://localhost:3000/discourse/${message}`,
                                requestOptions
                            )
                                .then(res => res.json())
                                .then(resolved => console.log("Fetch Response Too Yo!", resolved))

                            // A: pending...
                            // :alembic: username is undefined, but address is recoverable

                        }
                    })
            });
        } catch (error) {
            console.log("User denied Ethereum account access");
        }
    }
});
</script>

